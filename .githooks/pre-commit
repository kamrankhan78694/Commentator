#!/bin/sh
# Pre-commit hook for Commentator
# Runs linting, formatting, and security checks before commits

echo "ğŸ” Running pre-commit checks..."

# Check if npm is available
if ! command -v npm >/dev/null 2>&1; then
    echo "âŒ npm is required but not installed"
    exit 1
fi

# Run linting
echo "ğŸ“ Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
    echo "âŒ Linting failed. Please fix the issues and try again."
    echo "ğŸ’¡ Run 'npm run lint:fix' to auto-fix some issues"
    exit 1
fi

# Run formatting check
echo "ğŸ¨ Checking code formatting..."
npm run format
if [ $? -ne 0 ]; then
    echo "âŒ Code formatting failed. Please run 'npm run format' and try again."
    exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
npm test
if [ $? -ne 0 ]; then
    echo "âŒ Tests failed. Please fix the failing tests and try again."
    exit 1
fi

# Run security audit
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
    echo "âŒ Security audit found high/critical vulnerabilities."
    echo "ğŸ’¡ Run 'npm audit fix' to attempt automatic fixes"
    exit 1
fi

# Check for environment variables template
if [ ! -f ".env.example" ]; then
    echo "âŒ .env.example file is missing"
    exit 1
fi

# Check for hardcoded secrets (basic check)
echo "ğŸ” Checking for potential secrets..."
if git diff --cached --name-only | xargs grep -l "password\|secret\|key\|token" | grep -v ".env.example" | grep -v "test/" | head -1; then
    echo "âš ï¸  Potential secrets detected in staged files. Please review."
    echo "ğŸ’¡ Make sure sensitive data is in environment variables"
    # Don't exit here, just warn
fi

echo "âœ… All pre-commit checks passed!"
exit 0