<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Test - Commentator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .test-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1a202c;
        }
        .button {
            background: #0066ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .button:hover {
            background: #0052cc;
            transform: translateY(-1px);
        }
        .button:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .button-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }
        .button-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid;
        }
        .status-success {
            background: #f0fff4;
            border-color: #38a169;
            color: #22543d;
        }
        .status-error {
            background: #fed7d7;
            border-color: #e53e3e;
            color: #742a2a;
        }
        .status-info {
            background: #ebf8ff;
            border-color: #3182ce;
            color: #2a4365;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #4a5568;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #0066ff;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }
        .log-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }
        .log-entry {
            margin: 4px 0;
        }
        .log-success { color: #68d391; }
        .log-error { color: #fc8181; }
        .log-warning { color: #f6e05e; }
        .log-info { color: #63b3ed; }
    </style>
</head>
<body>
    <div class="test-card">
        <h1 class="test-header">üîê Authentication System Test</h1>
        <p>Testing all authentication methods for the Commentator platform</p>
        
        <div id="auth-status" class="status status-info">
            <strong>Status:</strong> Not authenticated
        </div>
        
        <div id="user-info" style="display: none;" class="status status-success">
            <strong>Current User:</strong>
            <div id="user-details"></div>
        </div>
    </div>

    <!-- Anonymous Authentication -->
    <div class="test-card">
        <h2>üë§ Anonymous Authentication</h2>
        <p>Sign in anonymously to post comments without creating an account</p>
        <button class="button" onclick="testAnonymousAuth()">Sign In Anonymously</button>
    </div>

    <!-- Email Authentication -->
    <div class="test-card">
        <h2>üìß Email Authentication</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Sign In -->
            <div>
                <h3>Sign In</h3>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="signin-email" class="form-input" placeholder="test@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="signin-password" class="form-input" placeholder="password123">
                </div>
                <button class="button" onclick="testEmailSignIn()">Sign In</button>
            </div>
            
            <!-- Sign Up -->
            <div>
                <h3>Sign Up</h3>
                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" id="signup-name" class="form-input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="signup-email" class="form-input" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="signup-password" class="form-input" placeholder="password123" minlength="6">
                </div>
                <button class="button" onclick="testEmailSignUp()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- Google Authentication -->
    <div class="test-card">
        <h2>üîç Google Authentication</h2>
        <p>Sign in with your Google account for quick access</p>
        <button class="button" onclick="testGoogleAuth()">Sign In with Google</button>
    </div>

    <!-- User Actions -->
    <div class="test-card">
        <h2>‚öôÔ∏è User Actions</h2>
        <button class="button button-secondary" onclick="getUserInfo()">Get User Info</button>
        <button class="button button-secondary" onclick="testSignOut()">Sign Out</button>
        <button class="button button-secondary" onclick="clearLog()">Clear Log</button>
    </div>

    <!-- Comment Test -->
    <div class="test-card">
        <h2>üí¨ Comment Test</h2>
        <p>Test comment submission with current authentication</p>
        <div class="form-group">
            <label class="form-label">Test URL</label>
            <input type="url" id="test-url" class="form-input" value="https://auth-test.example.com" placeholder="https://example.com">
        </div>
        <div class="form-group">
            <label class="form-label">Comment Text</label>
            <textarea id="test-comment" class="form-input" rows="3" placeholder="Test comment with authentication...">This is a test comment using the authenticated user!</textarea>
        </div>
        <button class="button" onclick="testCommentSubmission()">Submit Test Comment</button>
        <button class="button button-secondary" onclick="loadTestComments()">Load Comments</button>
    </div>

    <!-- Log Container -->
    <div class="test-card">
        <h2>üìã Test Log</h2>
        <div class="log-container" id="log-container">
            <div class="log-entry log-info">[Ready] Authentication test interface loaded</div>
        </div>
    </div>

    <!-- Load Firebase Services -->
    <script src="config/runtime-config.js"></script>
    <script src="config/environment.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="js/firebase-service.js"></script>

    <script type="module">
        // Import Firebase auth functions
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        
        let currentUser = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Initializing authentication test...', 'info');
            
            // Monitor auth state changes
            const auth = getAuth();
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateAuthStatus(user);
            });
            
            // Wait for Firebase service
            const checkService = () => {
                if (typeof window.FirebaseService !== 'undefined') {
                    log('Firebase service loaded successfully', 'success');
                } else {
                    setTimeout(checkService, 100);
                }
            };
            checkService();
        });
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span style="opacity: 0.7;">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateAuthStatus(user) {
            const statusEl = document.getElementById('auth-status');
            const userInfoEl = document.getElementById('user-info');
            const userDetailsEl = document.getElementById('user-details');
            
            if (user) {
                statusEl.className = 'status status-success';
                statusEl.innerHTML = `<strong>Status:</strong> Authenticated as ${user.isAnonymous ? 'Anonymous User' : user.displayName || user.email}`;
                
                userInfoEl.style.display = 'block';
                userDetailsEl.innerHTML = `
                    <div><strong>UID:</strong> ${user.uid}</div>
                    <div><strong>Email:</strong> ${user.email || 'Not provided'}</div>
                    <div><strong>Display Name:</strong> ${user.displayName || 'Not set'}</div>
                    <div><strong>Anonymous:</strong> ${user.isAnonymous ? 'Yes' : 'No'}</div>
                    <div><strong>Email Verified:</strong> ${user.emailVerified ? 'Yes' : 'No'}</div>
                `;
                
                log(`User authenticated: ${user.isAnonymous ? 'Anonymous' : user.email}`, 'success');
            } else {
                statusEl.className = 'status status-info';
                statusEl.innerHTML = '<strong>Status:</strong> Not authenticated';
                userInfoEl.style.display = 'none';
                log('User signed out', 'info');
            }
        }
        
        // Authentication Tests
        window.testAnonymousAuth = async function() {
            log('Testing anonymous authentication...', 'info');
            try {
                if (window.FirebaseService) {
                    const user = await window.FirebaseService.initAuth();
                    log('Anonymous authentication successful', 'success');
                } else {
                    throw new Error('Firebase service not available');
                }
            } catch (error) {
                log(`Anonymous authentication failed: ${error.message}`, 'error');
            }
        };
        
        window.testEmailSignIn = async function() {
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            
            if (!email || !password) {
                log('Please enter email and password', 'error');
                return;
            }
            
            log(`Testing email sign-in for: ${email}`, 'info');
            try {
                if (window.FirebaseService) {
                    const user = await window.FirebaseService.signInWithEmail(email, password);
                    log('Email sign-in successful', 'success');
                } else {
                    throw new Error('Firebase service not available');
                }
            } catch (error) {
                log(`Email sign-in failed: ${error.message}`, 'error');
            }
        };
        
        window.testEmailSignUp = async function() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (!name || !email || !password) {
                log('Please fill in all fields', 'error');
                return;
            }
            
            if (password.length < 6) {
                log('Password must be at least 6 characters', 'error');
                return;
            }
            
            log(`Testing account creation for: ${email}`, 'info');
            try {
                if (window.FirebaseService) {
                    const user = await window.FirebaseService.createAccount(email, password, name);
                    log('Account creation successful', 'success');
                } else {
                    throw new Error('Firebase service not available');
                }
            } catch (error) {
                log(`Account creation failed: ${error.message}`, 'error');
            }
        };
        
        window.testGoogleAuth = async function() {
            log('Testing Google authentication...', 'info');
            try {
                if (window.FirebaseService) {
                    const user = await window.FirebaseService.signInWithGoogle();
                    log('Google authentication successful', 'success');
                } else {
                    throw new Error('Firebase service not available');
                }
            } catch (error) {
                log(`Google authentication failed: ${error.message}`, 'error');
            }
        };
        
        window.testSignOut = async function() {
            log('Testing sign out...', 'info');
            try {
                if (window.FirebaseService) {
                    await window.FirebaseService.signOutUser();
                    log('Sign out successful', 'success');
                } else {
                    throw new Error('Firebase service not available');
                }
            } catch (error) {
                log(`Sign out failed: ${error.message}`, 'error');
            }
        };
        
        window.getUserInfo = function() {
            if (window.FirebaseService && currentUser) {
                const profile = window.FirebaseService.getUserProfile();
                log(`User profile: ${JSON.stringify(profile, null, 2)}`, 'info');
            } else {
                log('No user currently authenticated', 'warning');
            }
        };
        
        // Comment Test
        window.testCommentSubmission = async function() {
            const url = document.getElementById('test-url').value;
            const comment = document.getElementById('test-comment').value;
            
            if (!currentUser) {
                log('Please authenticate first', 'error');
                return;
            }
            
            if (!url || !comment) {
                log('Please enter URL and comment', 'error');
                return;
            }
            
            log('Testing comment submission...', 'info');
            try {
                const commentData = {
                    text: comment,
                    author: currentUser.displayName || currentUser.email || 'Anonymous',
                    votes: 0,
                    timestamp: new Date().toISOString()
                };
                
                const commentId = await window.FirebaseService.saveComment(url, commentData);
                log(`Comment submitted successfully! ID: ${commentId}`, 'success');
            } catch (error) {
                log(`Comment submission failed: ${error.message}`, 'error');
            }
        };
        
        window.loadTestComments = async function() {
            const url = document.getElementById('test-url').value;
            
            if (!url) {
                log('Please enter a URL', 'error');
                return;
            }
            
            log('Loading comments...', 'info');
            try {
                const comments = await window.FirebaseService.loadComments(url);
                log(`Loaded ${comments.length} comments`, 'success');
                
                comments.forEach((comment, index) => {
                    log(`Comment ${index + 1}: "${comment.text}" by ${comment.author}`, 'info');
                });
            } catch (error) {
                log(`Failed to load comments: ${error.message}`, 'error');
            }
        };
        
        window.clearLog = function() {
            document.getElementById('log-container').innerHTML = '';
            log('Log cleared', 'info');
        };
    </script>
</body>
</html>
