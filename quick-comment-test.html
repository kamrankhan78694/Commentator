<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Comment Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Quick Comment Test</h1>
        
        <div id="system-status">
            <div id="env-status" class="status info">Environment: Loading...</div>
            <div id="firebase-status" class="status info">Firebase: Loading...</div>
            <div id="auth-status" class="status info">Authentication: Pending...</div>
        </div>

        <div style="margin: 20px 0;">
            <h3>Test Comment Submission</h3>
            <input type="url" id="test-url" placeholder="https://example.com" value="https://quick-test.example.com">
            <textarea id="test-comment" placeholder="Enter test comment..." rows="3">This is a quick test after fixing the Firebase rules and browser compatibility issues!</textarea>
            <button onclick="submitComment()" id="submit-btn">Submit Comment</button>
            <button onclick="loadComments()">Load Comments</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="log" id="log-output"></div>
    </div>

    <!-- Load Configuration -->
    <script src="config/runtime-config.js"></script>
    <script src="config/environment.js"></script>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getDatabase, ref, set, get, push } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        let app, auth, database, currentUser = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const output = document.getElementById('log-output');
            const colors = {
                info: '#00ffff',
                success: '#00ff00',
                error: '#ff0000',
                warning: '#ffff00'
            };
            output.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function updateStatus(id, message, type) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function initializeFirebase() {
            try {
                log('üî• Initializing Firebase...', 'info');
                
                // Check for configuration
                if (typeof window.ENV_CONFIG !== 'undefined') {
                    const config = window.ENV_CONFIG.getFirebaseConfig();
                    log(`‚úÖ Environment config loaded: ${window.ENV_CONFIG.getEnvironment()}`, 'success');
                    updateStatus('env-status', `‚úÖ Environment: ${window.ENV_CONFIG.getEnvironment()}`, 'success');
                    
                    app = initializeApp(config);
                    auth = getAuth(app);
                    database = getDatabase(app);
                    
                    log(`üìç Database URL: ${config.databaseURL}`, 'info');
                    updateStatus('firebase-status', '‚úÖ Firebase Initialized', 'success');
                    
                    // Set up auth listener
                    onAuthStateChanged(auth, (user) => {
                        currentUser = user;
                        if (user) {
                            updateStatus('auth-status', `‚úÖ Authenticated (${user.uid.substring(0, 8)}...)`, 'success');
                            log(`üîê User authenticated: ${user.uid}`, 'success');
                        } else {
                            updateStatus('auth-status', '‚ö†Ô∏è Not authenticated', 'warning');
                        }
                    });
                    
                    log('‚úÖ Firebase initialization complete', 'success');
                    
                } else {
                    throw new Error('Environment configuration not found');
                }
                
            } catch (error) {
                log(`‚ùå Firebase initialization failed: ${error.message}`, 'error');
                updateStatus('firebase-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        window.submitComment = async function() {
            const url = document.getElementById('test-url').value;
            const comment = document.getElementById('test-comment').value;
            const submitBtn = document.getElementById('submit-btn');
            
            if (!url || !comment) {
                log('‚ùå Please enter both URL and comment', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                log('üìù Starting comment submission...', 'info');
                
                // Ensure user is authenticated
                if (!currentUser) {
                    log('üîê Authenticating user...', 'info');
                    await signInAnonymously(auth);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (!currentUser) {
                    throw new Error('Authentication failed');
                }
                
                log(`‚úÖ User authenticated: ${currentUser.uid}`, 'success');
                
                // Generate URL hash
                const urlHash = btoa(url).replace(/[+/=]/g, '');
                log(`üîë URL hash: ${urlHash}`, 'info');
                
                // Prepare comment data
                const commentData = {
                    text: comment,
                    author: 'Quick Test User',
                    timestamp: Date.now(),
                    userId: currentUser.uid,
                    createdAt: Date.now(),
                    votes: 0
                };
                
                log(`üìä Comment data prepared`, 'info');
                
                // Submit to Firebase
                const commentsRef = ref(database, `comments/${urlHash}`);
                const newCommentRef = push(commentsRef);
                await set(newCommentRef, commentData);
                
                log(`‚úÖ Comment submitted successfully! ID: ${newCommentRef.key}`, 'success');
                document.getElementById('test-comment').value = '';
                
            } catch (error) {
                log(`‚ùå Comment submission failed: ${error.message}`, 'error');
                log(`üìä Error details: ${JSON.stringify({
                    code: error.code,
                    message: error.message
                })}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Comment';
            }
        };

        window.loadComments = async function() {
            const url = document.getElementById('test-url').value;
            
            if (!url) {
                log('‚ùå Please enter a URL', 'error');
                return;
            }
            
            try {
                log(`üìñ Loading comments for: ${url}`, 'info');
                
                const urlHash = btoa(url).replace(/[+/=]/g, '');
                const commentsRef = ref(database, `comments/${urlHash}`);
                const snapshot = await get(commentsRef);
                
                if (snapshot.exists()) {
                    const commentsData = snapshot.val();
                    const comments = Object.keys(commentsData).map(key => ({
                        id: key,
                        ...commentsData[key]
                    }));
                    
                    log(`‚úÖ Found ${comments.length} comments`, 'success');
                    comments.forEach((comment, index) => {
                        log(`üìù Comment ${index + 1}: "${comment.text}" by ${comment.author}`, 'info');
                    });
                } else {
                    log('‚ÑπÔ∏è No comments found for this URL', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Failed to load comments: ${error.message}`, 'error');
            }
        };

        window.clearLog = function() {
            document.getElementById('log-output').innerHTML = '';
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Quick Comment Test initialized', 'info');
            initializeFirebase();
        });
    </script>
</body>
</html>
